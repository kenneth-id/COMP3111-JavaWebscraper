<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>Controller.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">COMP3111-TKOXP</a> &gt; <a href="index.source.html" class="el_package">comp3111.webscraper</a> &gt; <span class="el_source">Controller.java</span></div><h1>Controller.java</h1><pre class="source lang-java linenums">package comp3111.webscraper;


import javafx.fxml.FXML;
import javafx.scene.control.Label;
import javafx.scene.control.TableCell;
import javafx.scene.control.TableColumn;
import javafx.scene.control.TableView;
import javafx.scene.control.TextField;
import javafx.scene.input.MouseEvent;
import javafx.scene.control.TextArea;
import javafx.scene.control.Hyperlink;
import javafx.scene.control.ComboBox;
import javafx.scene.Node;
import javafx.scene.chart.AreaChart;
import javafx.scene.chart.XYChart;
import javafx.scene.chart.XYChart.Data;
import javafx.collections.ObservableList;
import javafx.event.ActionEvent;
import javafx.event.EventHandler;
import javafx.collections.FXCollections;
import javafx.scene.control.Button;

import java.util.ArrayList;
import java.util.List;


import java.awt.Desktop;
import java.io.IOException;
import java.net.URI;
import java.net.URISyntaxException;
import java.net.URL;
import java.util.Iterator;
import java.util.List;
//import com.google.common.collect.EvictingQueue;
import java.util.ListIterator;
import java.awt.*;
//import java.awt.Button;

import javafx.application.HostServices;


import javafx.util.Callback;
import javafx.collections.FXCollections;
import javafx.scene.control.cell.PropertyValueFactory;

import java.time.LocalDateTime;

/**
 * 
 * @author kevinw
 *
 *
 * Controller class that manage GUI interaction. Please see document about JavaFX for details.
 * 
 */
public class Controller {

    @FXML 
    private Label labelCount; 

    @FXML 
    private Label labelPrice; 

    @FXML 
    private Hyperlink labelMin; 

    @FXML 
    private Hyperlink labelLatest; 

    @FXML
    private TextField textFieldKeyword;
    
    @FXML
    private TextArea textAreaConsole;
    
    @FXML
    private AreaChart&lt;String, Number&gt; areaChartTrend;
    
    @FXML
    private ComboBox&lt;String&gt; comboBoxTrend;
    
    private WebScraper scraper;
    
    private List&lt;Item&gt; result;
    
    private ObservableList&lt;String&gt; lastFiveSearches;
    
    private ArrayList&lt;List&lt;Item&gt;&gt; lastFiveResults;
    
    private ArrayList&lt;Trend&gt; lastFiveTrends;
    
    @FXML
    private TableView&lt;Item&gt; tableControl;

    @FXML
    private TableColumn title;

    @FXML
    private TableColumn price;

    @FXML
    private TableColumn&lt;Item, String&gt; url;

    @FXML
    private TableColumn&lt;Item, LocalDateTime&gt; postedDate;
    
    @FXML
    private Button refineID;

    @FXML
    private Button goID;
    
    @FXML
    private TextField textFieldKeywordRefine;
    
    private String beforeRefine; // to store keyword before refining
    
    
    /**
     * Default controller
     */
<span class="nc" id="L123">    public Controller() {</span>
<span class="nc" id="L124">    	scraper = new WebScraper();</span>
<span class="nc" id="L125">    	lastFiveSearches = FXCollections.observableArrayList();</span>
<span class="nc" id="L126">    	lastFiveResults= new ArrayList&lt;List&lt;Item&gt;&gt;();</span>
<span class="nc" id="L127">    	lastFiveTrends = new ArrayList&lt;Trend&gt;();</span>
<span class="nc" id="L128">    }</span>

    /**
     * Default initializer. It is empty.
     */
    @FXML
    private void initialize() {
    	//refineID.setDisable(true); // set refine button to disable on construction
<span class="nc" id="L136">    }</span>

    private void updateAllTabs() {
<span class="nc" id="L139">    	updateTableTab();</span>
<span class="nc" id="L140">    }</span>
    
    	
    /**
     * Called when the search button is pressed.
     */
    @FXML
    private void actionSearch() {
<span class="nc" id="L148">    	String searchKeyWord =textFieldKeyword.getText();</span>
<span class="nc" id="L149">    	System.out.println(&quot;actionSearch: &quot; + searchKeyWord);</span>
    	
    	
<span class="nc" id="L152">    	comboBoxTrend.setItems(lastFiveSearches);</span>
<span class="nc" id="L153">    	System.out.println(&quot;Begin scraping&quot;);</span>
<span class="nc" id="L154">    	result = scraper.scrape(searchKeyWord);</span>
<span class="nc" id="L155">    	System.out.println(&quot;Finished scraping&quot;);</span>
<span class="nc" id="L156">    	Trend searchTrend = new Trend (result);</span>
<span class="nc bnc" id="L157" title="All 2 branches missed.">    	if(!lastFiveSearches.contains(searchKeyWord)) {</span>
<span class="nc" id="L158">	    	addToLastFiveResults(result);</span>
<span class="nc" id="L159">	    	addToLastFiveTrends(searchTrend);</span>
<span class="nc" id="L160">	    	addToLastFiveSearches(searchKeyWord);</span>
    	}
    	
<span class="nc" id="L163">    	updateTrendChart(searchTrend,searchKeyWord);</span>
//    	
//    	String output = &quot;Items scraped from craiglist and carousell (Currency in USD) \n &quot;;
//    	for (Item item : result) {
//    		output += item.getTitle() + &quot;\t&quot; + item.getPrice() +	 &quot;\t&quot; 
//    	+ item.getOrigin() +	 &quot;\t&quot; +item.getUrl() + &quot;\n&quot;;
//    	}
//    	textAreaConsole.setText(output);
    	
<span class="nc" id="L172">    	updateConsole(result);</span>

<span class="nc" id="L174">    	beforeRefine = textFieldKeyword.getText();</span>
<span class="nc" id="L175">    	refineID.setDisable(false);</span>
<span class="nc" id="L176">    	updateAllTabs();</span>
<span class="nc" id="L177">    }</span>
    
    @FXML
    /**
	 * Called when the Value property of the combobox in the Trend tab is changed.
	 * @author kenneth-id
	 */
    void trendComboBoxAction(ActionEvent event) {
<span class="nc" id="L185">    	String comboString = comboBoxTrend.getValue();</span>
<span class="nc" id="L186">    	System.out.println(comboString);</span>
<span class="nc" id="L187">    	int index = lastFiveSearches.indexOf(comboString);</span>
<span class="nc" id="L188">    	Trend comboTrend = lastFiveTrends.get(index);</span>
<span class="nc" id="L189">    	updateTrendChart(comboTrend,comboString);</span>
<span class="nc" id="L190">    	updateConsole(lastFiveResults.get(index));</span>
<span class="nc" id="L191">    }</span>
    
    /**
	 * Helper method to update the chart in the Trend tab 
	 * @author kenneth-id
	 * @param searchTrend - Trend object 
	 * @param searchKeyWord - String of the searched keyword 
	 */
    private void updateTrendChart(Trend searchTrend, String searchKeyWord) {
    	//remove previous linechart
<span class="nc" id="L201">    	areaChartTrend.getData().clear();</span>
<span class="nc" id="L202">    	XYChart.Series&lt;String, Number&gt; averagePricesSeries = new XYChart.Series&lt;String, Number&gt;();</span>
<span class="nc" id="L203">    	averagePricesSeries.setName(&quot;The average selling price of the &quot; + searchKeyWord);</span>
<span class="nc" id="L204">    	int numberOfPoints=0;</span>
<span class="nc bnc" id="L205" title="All 2 branches missed.">    	for(int i=0; i&lt;7;i++) {</span>
<span class="nc bnc" id="L206" title="All 2 branches missed.">    		if(!(searchTrend.getAveragePricesList().get(i).equals(0.0))) {</span>
<span class="nc" id="L207">    		Data&lt;String,Number&gt; point =new Data&lt;String, Number&gt;(searchTrend.getDatesString().get(i), </span>
<span class="nc" id="L208">    				searchTrend.getAveragePricesList().get(i));</span>
<span class="nc" id="L209">    		averagePricesSeries.getData().add(point);</span>
<span class="nc" id="L210">    		numberOfPoints++;</span>
    		}
    	}
<span class="nc" id="L213">    	areaChartTrend.getData().addAll(averagePricesSeries);</span>
<span class="nc" id="L214">    	final int numberOfPointsFinal = numberOfPoints;</span>
    	//adding double click event handler to each point
<span class="nc bnc" id="L216" title="All 2 branches missed.">    	for(int i=0; i&lt;numberOfPointsFinal;i++) {</span>
<span class="nc" id="L217">    		Data&lt;String, Number&gt; currentDataPoint =areaChartTrend.getData().get(0).getData().get(i);</span>
<span class="nc" id="L218">    		Node currentNode =  currentDataPoint.getNode();</span>
<span class="nc" id="L219">    		currentNode.addEventHandler(MouseEvent.MOUSE_PRESSED,</span>
<span class="nc" id="L220">        		    new EventHandler&lt;MouseEvent&gt;() {</span>
    		        @Override 
    		        public void handle(MouseEvent mouseEvent) {
<span class="nc bnc" id="L223" title="All 4 branches missed.">    		                 if(mouseEvent.isPrimaryButtonDown() &amp;&amp; mouseEvent.getClickCount() == 2){</span>
    		                	 
<span class="nc" id="L225">    		                	 ArrayList&lt;Node&gt; bluePoints = new ArrayList&lt;Node&gt;();</span>
<span class="nc bnc" id="L226" title="All 2 branches missed.">    		                	 for(int i=0 ; i&lt;numberOfPointsFinal ;i++) {</span>
    		                		 
<span class="nc" id="L228">    		                		 Node currentNode =  areaChartTrend.getData().get(0).getData().get(i).getNode();</span>
<span class="nc bnc" id="L229" title="All 2 branches missed.">    		                		 if((currentNode.getStyle() == &quot;-fx-background-color: blue;&quot;)){</span>
<span class="nc" id="L230">    		                			 bluePoints.add(currentNode);</span>
        		                     }
    		                	 }
<span class="nc bnc" id="L233" title="All 2 branches missed.">    		                	 for(Node bluePoint : bluePoints) {</span>
<span class="nc" id="L234">    		                		 bluePoint.setStyle(&quot;&quot;);</span>
<span class="nc" id="L235">    		                	 }</span>
<span class="nc bnc" id="L236" title="All 2 branches missed.">    		                	 if(!currentNode.getStyle().equals(&quot;-fx-background-color: blue;&quot;) ) {</span>
<span class="nc" id="L237">    		                     currentNode.setStyle(&quot;-fx-background-color: blue;&quot;);</span>
<span class="nc" id="L238">    		                     int dateIndex = searchTrend.getDateIndex(currentDataPoint.getXValue());</span>
<span class="nc" id="L239">    		                     updateConsole(searchTrend.getItemList(dateIndex));</span>
    		                	 }
    		                 }
<span class="nc" id="L242">    		         }</span>
    		    });
    	}
<span class="nc" id="L245">    }</span>
    
    /**
     * Called when the new button is pressed. Very dummy action - print something in the command prompt.
     */
    @FXML
    private void actionNew() {
<span class="nc" id="L252">    	System.out.println(&quot;actionNew&quot;);</span>
<span class="nc" id="L253">    }    </span>
    
    private void updateConsole(List&lt;Item&gt; result) {
<span class="nc" id="L256">    	System.out.println(&quot;Items from Craiglist and Carousell: \n&quot;);</span>
<span class="nc" id="L257">    	String output = &quot;&quot;;</span>
<span class="nc bnc" id="L258" title="All 2 branches missed.">    	for (Item item : result) {</span>
<span class="nc" id="L259">    		output += item.getTitle() + &quot;\t&quot; + item.getPrice() +	 &quot;\t&quot; </span>
<span class="nc" id="L260">    				+ item.getOrigin() +	 &quot;\t&quot; +item.getUrl() + &quot;\n&quot;;</span>
<span class="nc" id="L261">    	}</span>
    	
<span class="nc" id="L263">    	textAreaConsole.setText(output);</span>
<span class="nc" id="L264">    }</span>
    
    /**
	 * Helper method to add a String object to the ArrayList lastFiveSearches 
	 * @author kenneth-id
	 * @param toAdd  String object to be added into the ArrayList 
	 */
    private void addToLastFiveSearches (String toAdd) {
<span class="nc bnc" id="L272" title="All 2 branches missed.">    	if(lastFiveSearches.size()&lt;5 ) {</span>
<span class="nc" id="L273">    		lastFiveSearches.add(toAdd);</span>
    	}
    	else {
<span class="nc" id="L276">    		lastFiveSearches.remove(0);</span>
<span class="nc" id="L277">    		lastFiveSearches.add(toAdd);</span>
    	}
<span class="nc" id="L279">    }</span>
    
    /**
	 * Helper method to add a List of Items to the ArrayList lastFiveResults 
	 * @author kenneth-id
	 * @param toAdd  List of Item objects to be added into the ArrayList 
	 */
    private void addToLastFiveResults (List&lt;Item&gt; toAdd ) {
<span class="nc bnc" id="L287" title="All 2 branches missed.">    	if(lastFiveSearches.size()&lt;5) {</span>
<span class="nc" id="L288">    		lastFiveResults.add(toAdd);</span>
    	}
    	else {
<span class="nc" id="L291">    		lastFiveResults.remove(0);</span>
<span class="nc" id="L292">    		lastFiveResults.add(toAdd);</span>
    	}
<span class="nc" id="L294">    }</span>
    
    /**
	 * Helper method to add a Trend object to the ArrayList lastFiveTrends 
	 * @author kenneth-id
	 * @param toAdd  Trend object to be added into the ArrayList 
	 */
    private void addToLastFiveTrends (Trend toAdd ) {
<span class="nc bnc" id="L302" title="All 2 branches missed.">    	if(lastFiveSearches.size()&lt;5) {</span>
<span class="nc" id="L303">    		lastFiveTrends.add(toAdd);</span>
    	}
    	else {
<span class="nc" id="L306">    		lastFiveTrends.remove(0);</span>
<span class="nc" id="L307">    		lastFiveTrends.add(toAdd);</span>
    	}
<span class="nc" id="L309">    }</span>
    

    @FXML
    private void mouseClicked() {
<span class="nc bnc" id="L314" title="All 2 branches missed.">    	if(textAreaConsole.getText().isEmpty()) {</span>
<span class="nc" id="L315">    		refineID.setDisable(true);</span>
<span class="nc" id="L316">    		return;</span>
    	}
<span class="nc" id="L318">    }</span>
    
    private List&lt;Item&gt; findTitleWithRefineKeyword(List&lt;Item&gt; result, String text) {

<span class="nc" id="L322">		Iterator&lt;Item&gt; iter = result.listIterator();</span>
<span class="nc bnc" id="L323" title="All 2 branches missed.">		while(iter.hasNext()) {</span>
<span class="nc" id="L324">			Item item = iter.next();</span>
<span class="nc bnc" id="L325" title="All 2 branches missed.">			if (item.getTitle().toLowerCase().contains(text.toLowerCase())==false) {    				</span>
<span class="nc" id="L326">				iter.remove();</span>
			}
<span class="nc" id="L328">		}</span>
    	
<span class="nc" id="L330">    	return result;</span>
    }
    
    @FXML
    private void refineSearch() {
    	//System.out.println(&quot;actionSearch: &quot; + textFieldKeyword.getText());
    	
    	//if(textFieldKeyword.getText().isEmpty() &amp;&amp; textFieldKeywordRefine.getText().isEmpty()) 
<span class="nc bnc" id="L338" title="All 2 branches missed.">    	if(textAreaConsole.getText().isEmpty()) {</span>
<span class="nc" id="L339">    		refineID.setDisable(true);</span>
<span class="nc" id="L340">    		return;</span>
    	}

<span class="nc bnc" id="L343" title="All 2 branches missed.">    	if(refineID.isDisabled()==false) {</span>
<span class="nc" id="L344">    		result = scraper.scrape(beforeRefine);</span>
    		// update result items
<span class="nc" id="L346">    		result = findTitleWithRefineKeyword(result, textFieldKeywordRefine.getText());</span>
    		
	    	//textAreaConsole.setText(printConsole(result));
	    	
<span class="nc" id="L350">    		updateConsole(result);</span>
<span class="nc" id="L351">    		updateAllTabs();</span>
    	}
    	
<span class="nc" id="L354">    	refineID.setDisable(true);</span>
<span class="nc" id="L355">    }</span>
    
	private static class HyperlinkCell implements  Callback&lt;TableColumn&lt;Item, String&gt;, TableCell&lt;Item, String&gt;&gt; {
	    @Override
	    public TableCell&lt;Item, String&gt; call(TableColumn&lt;Item, String&gt; arg) {
<span class="nc" id="L360">	        TableCell&lt;Item, String&gt; cell = new TableCell&lt;Item, String&gt;() {</span>
	            @Override
	            protected void updateItem(String item, boolean empty) {
<span class="nc" id="L363">	            	Hyperlink item_casted = new Hyperlink(item);</span>
<span class="nc" id="L364">	                setGraphic(item_casted);</span>
<span class="nc" id="L365">	                item_casted.setOnAction(new EventHandler&lt;ActionEvent&gt;() {</span>
						@Override
						public void handle(ActionEvent arg0) {
							try {
<span class="nc" id="L369">								Desktop.getDesktop().browse(new URI(item));</span>
<span class="nc" id="L370">							} catch(IOException e1) {</span>
<span class="nc" id="L371">								e1.printStackTrace();</span>
<span class="nc" id="L372">							} catch(URISyntaxException e1) {</span>
<span class="nc" id="L373">								e1.printStackTrace();</span>
<span class="nc" id="L374">							}</span>
<span class="nc" id="L375">						}</span>
	                	
	                });
<span class="nc" id="L378">	            }</span>
	        };
<span class="nc" id="L380">	        return cell;</span>
	    }
	}
    
    /** Task 4: Fill out table
     * Called when the table tab is clicked
     * **/
    @FXML
    private void updateTableTab() {
<span class="nc" id="L389">    	tableControl.setEditable(false);</span>
    	
<span class="nc" id="L391">    	ObservableList&lt;Item&gt; data = FXCollections.observableArrayList(result);</span>
    	
<span class="nc" id="L393">    	title.setCellValueFactory(new PropertyValueFactory&lt;Item,String&gt;(&quot;title&quot;));</span>
<span class="nc" id="L394">    	price.setCellValueFactory(new PropertyValueFactory&lt;Item,Double&gt;(&quot;price&quot;));</span>
<span class="nc" id="L395">    	url.setCellValueFactory(new PropertyValueFactory&lt;Item,String&gt;(&quot;url&quot;));</span>
<span class="nc" id="L396">    	url.setCellFactory(new HyperlinkCell());</span>
<span class="nc" id="L397">    	postedDate.setCellValueFactory(new PropertyValueFactory&lt;Item,LocalDateTime&gt;(&quot;postedDate&quot;));</span>
    	
    	// Set Data to Table Control
<span class="nc" id="L400">    	tableControl.setItems(data);</span>
    	
    	// Set all columns with data
<span class="nc" id="L403">    	tableControl.getColumns().setAll(title,price,url,postedDate);</span>
    
<span class="nc" id="L405">    }</span>
}

</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.1.201803210924</span></div></body></html>